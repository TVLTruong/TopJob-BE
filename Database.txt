-- 1. Bảng users
CREATE TABLE users (
    id                  BIGSERIAL PRIMARY KEY,
    email               VARCHAR(255) UNIQUE NOT NULL,
    password_hash       VARCHAR(255) NOT NULL,
    role                VARCHAR(20) NOT NULL CHECK (role IN ('candidate', 'employer', 'admin')),
    is_verified         BOOLEAN DEFAULT FALSE,
    status              VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'banned')),
    
    email_verified_at   TIMESTAMP NULL,
    last_login_at       TIMESTAMP NULL,

    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

-- 2. Bảng candidates
CREATE TABLE candidates (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             BIGINT UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    full_name           VARCHAR(255) NOT NULL,
    gender              VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
    date_of_birth       DATE NULL,
    phone_number        VARCHAR(20) NULL,

    avatar_url          TEXT NULL,
    cv_url              TEXT NULL,
    bio                 TEXT NULL,
    personal_url        TEXT NULL,

    address_street      VARCHAR(255),
    address_district    VARCHAR(100),
    address_city        VARCHAR(100),
    address_country     VARCHAR(100),

    experience_years    INT DEFAULT 0,
    education_level     VARCHAR(100) NULL,

    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

-- 3. Bảng employers
CREATE TABLE employers (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             BIGINT UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    full_name           VARCHAR(255) NOT NULL,
    company_name        VARCHAR(255) NOT NULL,
    work_title          VARCHAR(255) NULL,
    description         TEXT NULL,
    website             TEXT NULL,

    logo_url            TEXT NULL,
    founded_year        INT NULL,

    contact_email       VARCHAR(255),
    contact_phone       VARCHAR(20),

    is_approved         BOOLEAN DEFAULT FALSE,   -- do admin duyệt
    status              VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending','active','banned')),

    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

-- 4. Bảng employer_locations
CREATE TABLE employer_locations (
    id BIGSERIAL PRIMARY KEY,
    employer_id BIGINT NOT NULL REFERENCES employers(id) ON DELETE CASCADE,
    is_headquarters BOOLEAN DEFAULT false,
    street_address VARCHAR(255),
    ward VARCHAR(255),
    city VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 5. Bảng companies_categories
CREATE TABLE companies_categories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 6. Bảng jobs_categories
CREATE TABLE jobs_categories (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT REFERENCES jobs_categories(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 7. Bảng jobs
CREATE TABLE jobs (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    requirements TEXT,
    nice_to_have TEXT,
    salary_min NUMERIC(12,2),
    salary_max NUMERIC(12,2),
    salary_currency VARCHAR(10),
    is_negotiable BOOLEAN DEFAULT false,
    location_text VARCHAR(255),
    job_type VARCHAR(50), -- full-time, part-time, contract...
    experience_level VARCHAR(50),
    positions_available INT DEFAULT 1,
    required_skills TEXT[], -- array of skills
    benefits TEXT[],         -- array of benefits
    status VARCHAR(20) DEFAULT 'draft', -- draft | published | closed
    deadline TIMESTAMP,
    published_at TIMESTAMP,
    application_count INT DEFAULT 0,
    is_featured BOOLEAN DEFAULT false,
    is_urgent BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 8. Bảng applications
CREATE TABLE applications (
    id BIGSERIAL PRIMARY KEY,
    cv_url TEXT,
    cover_letter TEXT,
    status VARCHAR(50) DEFAULT 'applied', -- applied | reviewed | interviewed | hired | rejected
    status_updated_at TIMESTAMP,
    employer_note TEXT,
    rating INT,
    applied_at TIMESTAMP DEFAULT NOW(),
    reviewed_at TIMESTAMP,
    interview_scheduled_at TIMESTAMP,
    interview_notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 9. Bảng saved_jobs
CREATE TABLE saved_jobs (
    id BIGSERIAL PRIMARY KEY,
    candidate_id BIGINT NOT NULL REFERENCES candidates(id) ON DELETE CASCADE,
    saved_at TIMESTAMP DEFAULT NOW()
);

-- 10. Bảng otp_verifications
CREATE TABLE otp_verifications (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    otp VARCHAR(6) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    is_used BOOLEAN DEFAULT false,
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    used_at TIMESTAMP
);

-- 11. Bảng password_reset_tokens
CREATE TABLE password_reset_tokens (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    used_at TIMESTAMP
);

-- Indexes
CREATE INDEX idx_otp_verifications_email ON otp_verifications(email);
CREATE INDEX idx_otp_verifications_created_at ON otp_verifications(created_at);
